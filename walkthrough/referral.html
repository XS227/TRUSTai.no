<!doctype html>
<html lang="nb">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Henvisning registreres…</title>
  </head>
  <body>
    <p>Registrerer henvisningskode…</p>
    <script>
      const url = new URL(window.location.href);
      const path = String(url.pathname || '');
      const legacyMatch = path.match(/\/a\/([^/?#]+)/i);
      const shortMatch = path.match(/\/(amb[0-9a-z]+)(?:\/|$|\?|#)/i);
      const rawReferralCode = url.searchParams.get('ref') || legacyMatch?.[1] || shortMatch?.[1] || '';
      const referralCode = String(rawReferralCode).trim().toLowerCase().replace(/[^a-z0-9]/g, '');

      if (referralCode) {
        const normalizedReferralCode = referralCode.startsWith('amb') ? referralCode : `amb${referralCode.slice(0, 8)}`;
        localStorage.setItem('ambassadorRef', normalizedReferralCode);
      }

      const pathWithoutFile = path.replace(/\/[^/]*$/, '');
      const basePath = path.match(/^(.*?\/walkthrough)(?:\/|$)/i)?.[1] || pathWithoutFile;
      const target = String(url.searchParams.get('target') || `${basePath}/index.html`)
        .replace(/^https?:\/\/[^/]+/i, '')
        .replace(/\/\//g, '/');

      window.location.replace(target);
    </script>
  </body>
</html>
