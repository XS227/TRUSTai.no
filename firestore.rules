rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.isAdmin == true ||
        ('admin' in request.auth.token.roles)
      );
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    match /ambassadors/{ambassadorId} {
      allow read: if isAdmin() || isOwner(ambassadorId);
      allow create: if isSignedIn();
      allow update: if isAdmin() || (
        isOwner(ambassadorId) &&
        !('status' in request.resource.data.diff(resource.data).changedKeys())
      );
      allow delete: if isAdmin();
    }

    match /leads/{leadId} {
      allow create: if
        request.resource.data.keys().hasAll(['company', 'name', 'email']) &&
        request.resource.data.company is string &&
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.company.size() > 0 &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.email.size() > 3;
      allow read: if isAdmin() || (isSignedIn() && resource.data.ambassadorId == request.auth.uid);
      allow update: if isAdmin();
      allow delete: if false;
    }

    match /commissionCases/{commissionCaseId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.ambassadorId == request.auth.uid);
      allow write: if isAdmin();
    }

    match /wallets/{ambassadorId} {
      allow read: if isAdmin() || isOwner(ambassadorId);
      allow write: if false;
      match /ledger/{entryId} {
        allow read: if isAdmin() || isOwner(ambassadorId);
        allow write: if false;
      }
    }

    match /payouts/{payoutId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.ambassadorId == request.auth.uid);
      allow write: if isAdmin();
    }

    match /mail/{docId} {
      allow read, write: if false;
    }

    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
